---
title: "HawkesModel"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r package loading, include=FALSE}
library("hawkesbow")
library(readr)

```


## Fitting Hawkes model to marathon record data

Produce estimates for model, exponential Hawkes process, using MLE: 
- baseline intensity,
- reproduction mean  
- exponential fertility function rate

Note:  originally data was in days from the first world record which is set as time 0.  The model was fit through day 40,300 (the last record  at day 40,231).  Rescaling helps with visualization - several options, one put in years by dividing by 365.

Three parameter estimates are first output. 

NOTE:  the results change if one doesn't set a seed...rescaling seems to help variability in that.

```{r, warning = FALSE}
record_table_mod<-read_rds("record_table_mod.rds")

days_between = as.numeric(diff(record_table_mod$Date_ymd))
daysfromstart <- cumsum(days_between)
daysfromstart <- c(0,daysfromstart)  ### get data in terms of days from first record (time 0)

### Rescale 

  # max time is 400 (about 402 days per unit)
#daysfromstart_mod <- daysfromstart/max(daysfromstart)*100  
#days_between_mod = diff(daysfromstart_mod)
  # units of year
daysfromstart_mod2 <- daysfromstart/365 
days_between_mod2 = diff(daysfromstart_mod2)

set.seed(13)
optMarathon<-mle(daysfromstart_mod2,"Exponential",110.5)  # end date picked number greater than longest times
optMarathon$par
summary(optMarathon)
optMarathon$events
optMarathon$end

optMarathon$model$param
optMarathon$model$mean()  # expected value
optMarathon$model$dmean()  # Jacobian matrix of expected value
optMarathon$model$ddmean()  # Hessian matrix of expected value
optMarathon$model$loglik(daysfromstart, optMarathon$end)  #  log-likelihood
optMarathon$model$dloglik(daysfromstart, optMarathon$end)  # Jacobian matrix of log-lik
optMarathon$model$ddloglik(daysfromstart, optMarathon$end) # hessian matrix of log-lik



```
### Residuals

From the help:
"Outputs the residuals (values of the compensator at the times of arrival) of a Hawkes process. Useful function for diagnosis through the random time change theorem: the residuals should follow a unit rate Poisson process"
Based on the example in the help I assume should follow the y=x line...we see divergence here suggesting an issue (in what direction?)

```{r}

resid<-residuals(daysfromstart_mod2, fun = optMarathon$par[1], repr = optMarathon$par[2], 
                  family = "exp", rate = optMarathon$par[3])
resid
plot(resid)
abline(0, 1, col="red", lty="dashed")

```

### Compensator

From the help: the compensator (integrated intensity) of a Hawkes process...kind of cool, can see how the events (world records) up the intensity.  Event times are the plus symbols plotted below the intensity function line.

```{r}

compensate<-compensator(daysfromstart_mod2, t=0:111, fun = optMarathon$par[1], 
                        repr = optMarathon$par[2], family = "exp", rate = optMarathon$par[3])
plot(c(0:111),compensate,main="Full time period", type = "l")
points(daysfromstart_mod2,rep(0,length(daysfromstart_mod2)), pch=3)

  ### zoom in...
plot(c(0:30),compensate[1:31],main="Year 0 to 30", type = "l" )
points(daysfromstart_mod2[0:16],rep(0,length(daysfromstart_mod2[0:16])), pch=3)

```

## Simulation using Hawkes model with MLE parameter estimates from data

Simulation for the same number of years used in the estimation.  Last plot is the residuals - we see since from the model we simulated generally seem to follow the y=x line.

Intensity plots with the rescaling are much easier to see.  Different seeds different results, some have second "child".

```{r}
set.seed(777)
simRecs <- hawkes(110, fun = optMarathon$par[1], repr = optMarathon$par[2], 
                  family = "exp", rate = optMarathon$par[3]) 
plot(simRecs, intensity = FALSE)
plot(simRecs, intensity = TRUE)

plot(residuals(simRecs))
abline(0, 1, col="red", lty="dashed")
```







