---
title: "Is a sub 2 hour marathon in the near future?  Modeling rare events in sports."
author: Rodney X. Sturdivant, Ph.D., Baylor University and Nick Clark, Ph.D., West
  Point
output:
  beamer_presentation: default
  ioslides_presentation:
    logo: consulting_center_logo.png
header-includes:
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = F, message = F)
```

```{r package loading, include=FALSE}
library(tidyverse);theme_set(theme_minimal()); theme_update(text = element_text(family = "serif"))
library(ggplot2)
library(MASS)
library(Hmisc)
library(DescTools)
library(goftest)
library(readr)
library("hawkesbow")
library(readr)
library(MASS)
library(lubridate)
```

# Outline

- Baseball Rare Events (if needed only)

- Background

- Marathon Data

- Simple Model

- Self-Exciting Model

- Further Research

- SCORE 

# Background

![Golden Age?](NYTIMESarticle.png){width=50%}

## Are we living in a time of records?
- Idea:  seems like an increase in records falling, but is it just the nature of randomness?

## How can we address this question?
## What would randomness look like?

# 

![Rod Aloha 10K Run (San Diego, 2018), 2nd Age Group](aloharun.jpg){width=50%}

![Rod Last Marathon (LA, 2018), 1st, Glendora CA Runners](RodLAmarathon.png){height=30%}

# Marathon World Record Data

Men's Marathon world records since 1908

NEED TO CLEAN UP - NICER TABLE WITH JUST TIME NAME NATIONALITY DATE
MAYBE INCLUDE A COUPLE OF PICTURES OF PEOPLE

```{r}
record_table_mod<-read_rds("record_table_mod.rds")
knitr::kable(record_table_mod)
days_between = as.numeric(diff(record_table_mod$Date_ymd))
daysfromstart <- cumsum(days_between)
daysfromstart <- c(0,daysfromstart)  ### get data in terms of days from first record (time 0)
  # units of year
daysfromstart_mod2 <- daysfromstart/365 
days_between_mod2 = diff(daysfromstart_mod2)

```

# Visualizing the data

- Two and three hour times shown as horizontal lines

```{r}
td<-seconds_to_period(c(7500,8500,9500,10500))
timelabs <- sprintf('%02d:%02d:%02d', td@hour, minute(td), 
                                   round(second(td)))
p1<-plot(record_table_mod$Date_ymd, record_table_mod$Time_t, 
         type = "h", xlab = "Data (YMD)", ylab = "Record (H:M:S)", 
         yaxt = "n", ylim = c(7100,10800))
axis(2, at = c(7500,8500,9500,10500), labels = timelabs, 
     cex.axis = 0.75)
abline(a = 7200, b = 0, lty = 2, col = "red" )
abline(a = 3*60*60, b = 0, lty = 2, col = "red" )
```



# SIMPLE MODEL

## POISSON PROCESS 

A model for a series of discrete events where the average time between events is known, but the exact timing of events is "random" meeting the following criteria: 

-  Events are independent of each other. The occurrence of one event does not affect the probability another event will occur.

-  The average rate (events per time period) is constant.

-  Two events cannot occur at the same time.

# Poisson Process Interarrival Times

The time between events (known as the interarrival times) follow an exponential distribution defined as:

$$P(T>t) = e^{-\lambda t}$$

- T is the random variable of the time until the next event

- t is a specific time for the next event

- $\lambda$ is the rate:  the average number of events per unit of time.  

Note the possible values of T are greater than 0 (positive only).  


# Reasonableness of Exponential Interarrivals

The exponential distribution has certain attributes, for example:

$E(T) = 1/\lambda$
$SD(T) = 1/\lambda$

The mean and standard deviation of the years between records:

```{r}

mean(days_between_mod2)
sd(days_between_mod2)

hist(days_between_mod2)
```

#  MORE ON THE SIMPLE MODEL

We estimate (MLE) 
$\lambda = 1/E(T)$

```{r}
expfit=fitdistr(days_between_mod2,"exponential")
exprate<-expfit$estimate
exprate
```
Model fit  

```{r}
x=density(days_between_mod2)
hist(days_between_mod2,main="Histogram, density curve and exponential model",xlab="Interarrival Time",freq=FALSE,ylim=c(0,0.5))
lines(x,col="red",lty = 2, lwd = 2)
curve(dexp(x, rate = exprate),col=3, lty = 3, lwd = 2, add = TRUE)

```

# Fit of simple model

```{r}
ks.test(days_between_mod2,pexp,rate=exprate)

cvm.test(days_between_mod2,"pexp",rate=exprate,estimated = TRUE)
ad.test(days_between_mod2,"pexp",rate=exprate,estimated = TRUE)


```

# Fit of simple model B



```{r}
x=seq(0,max(days_between_mod2),0.1)
plot(x,pexp(x,rate=exprate),type="l",col="red", main="EDF and Exponential CDF",xlab="Interarrival Time",ylab="Proportion <= x")
Ecdf(days_between_mod2,xlab='Interarrival Times',subtitle=FALSE,add=TRUE)
```


# Are records then random?

```{r}

PlotQQ(days_between_mod2, function(p) qexp(p, rate=exprate))

```

# What are the poorly fit points?

LOOK BACK AT THE ORIGINAL DATA HERE...LONGEST TIMES BETWEEN EVENTS (I THINK - NEED TO LOOK MORE CLOSELY)...ONE IS WW2 PRETTY SURE...THE OTHER NEED TO LOOK AGAIN - MAYBE AN UNUSUALLY LARGE LOWERING OF THE RECORD OR SOMETHING?

# A "Self-Exciting" Model

## Hawkes Processes

- Let $H_t$ be the history of events up to time $t$.  The Hawkes (1971) model of the conditional intensity is:

$$\lambda(t|H_t) = \nu + \sum_{i:t_i<t} g(t - t_i)$$
where $\nu$ is the background rate of events and g is the "triggering function".

- The "triggering" function can be further decomposed:

$$g = \mu g^*$$
where $g^*$ is a density function known as the "reproduction kernel" and $\mu$ is known as the "reproduction" mean.  

- A common choice for the "reproduction kernel" is the exponential density given by:

$$g^*(t) = \beta e^{-\beta t} $$

# Fitting the model


```{r}
set.seed(1234)
optMarathon<-mle(daysfromstart_mod2,"Exponential",114)  # end date picked number greater than longest times
nu = optMarathon$par[1]
mu = optMarathon$par[2]
b = optMarathon$par[3]

```

Parameter estimates for marathon data (exponential) Hawkes process, using MLE: 

- baseline intensity  `r round(nu,3)`
- reproduction mean  `r round(mu,3)`
- exponential reproduction function rate `r round(b,3)`

Note the baseline intensity is slightly lower than the constant model rate estimate of `r round(exprate,3)`

The estimated reproduction function is then: 

$$g(t) = \mu g^*(t) = \mu \beta e^{-\beta t} $$
$$ = `r round(mu,2)` * `r round(b,2)` e^{-`r round(b,2)` t} $$

# Model implications

```{r}
rate0=mu*b
```


At the instant of the first event (world record), $t = t_1$ so $g(t - t_1 = 0)$ and the reproduction rate is:

$$g(0) = `r round(mu,2)` * `r round(b,2)` e^{-`r round(b,2)` 0} = `r round(mu,2)` * `r round(b,2)` =  `r round(rate0,3)` $$

- The rate increases from the baseline rate of `r round(nu,3)` by this amount at the moment of this occurrence

- The rate then decays back to baseline over time (unless a new event occurs).

- Each new event "excites" the rate to increase and then decay

# The Intensity Function over Time

Below is based on a simulation of the intensity function over a 100 year period.  NOTE: HERE WOULD BE NICE TO SHOW FOR OUR DATA ALTHOUGH MIGHT NOT GIVE THE FULL PICTURE ANYWAY

```{r}
set.seed(777)
simRecs_Hawkes <- hawkes(100, fun = optMarathon$par[1], repr = optMarathon$par[2], family = "exp", rate = optMarathon$par[3]) 

plot(simRecs_Hawkes, intensity = TRUE)



```

# Intensity compared to the constant rate model

```{r}

plot(simRecs_Hawkes, intensity = TRUE)
abline(a = exprate, b = 0, lty = 2, col = "blue")

```


# Process as "Generations"

```{r}
plot(simRecs_Hawkes, intensity = FALSE)
```

# The Compensator Function

NEED TO WORK ON EXPLAINING - BELOW IS THE VERSION TAKING OUT BASELINE...MAYBE START WITH CONSTANT (CAN DO Poisson MODEL AND THEN THE BASELINE RATE HERE)

```{r}

compensate<-compensator(daysfromstart_mod2, t=0:111, fun = optMarathon$par[1], 
                        repr = optMarathon$par[2], family = "exp", rate = optMarathon$par[3])
plot(c(0:111),compensate-optMarathon$par[1]*seq(0,111),main="Full time period", type = "l")
points(daysfromstart_mod2,rep(0,length(daysfromstart_mod2)), pch=3)

```

# Residuals



# References

Data source: Wikipedia (https://en.wikipedia.org/wiki/Marathon_world_record_progression) scraped August 12, 2022

Poisson process:
https://towardsdatascience.com/the-poisson-distribution-and-poisson-process-explained-4e2cb17d459

Hawkes, Alan G. 1971. “Spectra of Some Self-Exciting and Mutually Exciting Point Processes.” Biometrika
58 (1): 83–90. https://doi.org/10.2307/2334319.

"Hawkesbow" package...

